const express = require('express');
const cors = require('cors');
const multer = require('multer');
const TelegramBot = require('node-telegram-bot-api');
const OpenAI = require('openai');
const sqlite3 = require('sqlite3');
const path = require('path');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

// Middleware
app.use(cors());
app.use(express.json());

// Serve static files from React build
app.use(express.static(path.join(__dirname, '../dist')));

// Multer Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        cb(null, '../uploads/');
    },
    filename: (req, file, cb) => {
        cb(null, Date.now() + '-' + file.originalname);
    }
});

const upload = multer({
    storage,
    limits: {
        fileSize: 10 * 1024 * 1024 // 10MB
    },
    fileFilter: (req, file, cb) => {
        if (file.mimetype.startsWith('image/')) {
            cb(null, true);
        } else {
            cb(new Error('Only image files are allowed!'), false);
        }
    }
});

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
const db = new sqlite3.Database('../bot.db');

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†
db.serialize(() => {
    db.run(`CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    telegram_id INTEGER UNIQUE,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`);

    db.run(`CREATE TABLE IF NOT EXISTS photo_uploads (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    file_path TEXT,
    ai_analysis TEXT,
    uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
  )`);
});

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Telegram Ð±Ð¾Ñ‚Ð°
console.log('ðŸ¤– Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Telegram Ð±Ð¾Ñ‚Ð°...');
console.log('Token:', process.env.TELEGRAM_BOT_TOKEN ? 'ÐÐ°Ð¹Ð´ÐµÐ½' : 'ÐÐ• ÐÐÐ™Ð”Ð•Ð!');

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð¾Ñ‚ Ð±ÐµÐ· Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ polling
const bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { 
    polling: {
        interval: 1000,
        autoStart: true,
        params: {
            timeout: 10
        }
    }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð±Ð¾Ñ‚Ð°
bot.on('error', (error) => {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Telegram Ð±Ð¾Ñ‚Ð°:', error);
    // Ð•ÑÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° 409 (ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚), Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ polling Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ
    if (error.code === 'ETELEGRAM' && error.response?.statusCode === 409) {
        console.log('âš ï¸ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚: Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð±Ð¾Ñ‚Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚');
        console.log('ðŸ”„ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ polling Ð¸ Ð¶Ð´ÐµÐ¼ 5 ÑÐµÐºÑƒÐ½Ð´...');
        bot.stopPolling().then(() => {
            setTimeout(() => {
                console.log('ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ polling...');
                bot.startPolling().catch(err => {
                    console.error('âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ polling:', err.message);
                });
            }, 5000);
        }).catch(err => {
            console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ polling:', err.message);
        });
    }
});

bot.on('polling_error', (error) => {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° polling:', error);
    // Ð•ÑÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° 409, ÑÑ‚Ð¾ Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ ÑƒÐ¶Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
    if (error.code === 'ETELEGRAM' && error.response?.statusCode === 409) {
        console.log('âš ï¸ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð”Ñ€ÑƒÐ³Ð¾Ð¹ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð±Ð¾Ñ‚Ð° ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');
        console.log('ðŸ’¡ Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾:');
        console.log('   1. Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð±Ð¾Ñ‚ (node server/index.js)');
        console.log('   2. ÐÐ° Railway Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹');
        console.log('   3. Ð¡Ñ‚Ð°Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ð±Ð¾Ñ‚Ð° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹');
    }
});

// Graceful shutdown
process.on('SIGTERM', () => {
    console.log('ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¸Ð³Ð½Ð°Ð» SIGTERM, Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°...');
    bot.stopPolling().then(() => {
        console.log('âœ… Polling Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½');
        process.exit(0);
    });
});

process.on('SIGINT', () => {
    console.log('ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¸Ð³Ð½Ð°Ð» SIGINT, Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°...');
    bot.stopPolling().then(() => {
        console.log('âœ… Polling Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½');
        process.exit(0);
    });
});

console.log('âœ… Telegram Ð±Ð¾Ñ‚ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½');

// Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð±Ð¾Ñ‚Ð°
bot.setMyCommands([
    { command: 'start', description: 'ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ AI Photo Analyzer' },
    { command: 'help', description: 'â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸' }
]);

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ OpenAI
const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº
function checkUploadLimit(telegramId) {
    return new Promise((resolve, reject) => {
        const today = new Date().toISOString().split('T')[0];

        db.get(`
      SELECT COUNT(*) as count 
      FROM photo_uploads pu 
      JOIN users u ON pu.user_id = u.id 
      WHERE u.telegram_id = ? AND DATE(pu.uploaded_at) = ?
    `, [telegramId, today], (err, row) => {
            if (err) {
                reject(err);
            } else {
                resolve(row.count < 3);
            }
        });
    });
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ñ„Ð¾Ñ‚Ð¾ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð˜Ð˜
async function analyzePhoto(imagePath) {
    try {
        // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ URL, ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
        let imageBuffer;
        if (imagePath.startsWith('http')) {
            const axios = require('axios');
            const response = await axios.get(imagePath, { responseType: 'arraybuffer' });
            imageBuffer = Buffer.from(response.data);
        } else {
            // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ, Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»
            const fs = require('fs');
            imageBuffer = fs.readFileSync(imagePath);
        }

        const response = await openai.chat.completions.create({
            model: "gpt-4-vision-preview",
            messages: [
                {
                    role: "user",
                    content: [
                        {
                            type: "text",
                            text: "ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÑ‚Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¸ Ð´Ð°Ð¹ ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹, Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð¸Ð»Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ‚Ð¾Ð³Ð¾, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð²Ð¸Ð´Ð¸ÑˆÑŒ. Ð‘ÑƒÐ´ÑŒ ÐºÑ€ÐµÐ°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¼ Ð¸ Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ð¼ Ð² ÑÐ²Ð¾ÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚Ðµ. ÐžÑ‚Ð²ÐµÑ‚ÑŒ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ."
                        },
                        {
                            type: "image_url",
                            image_url: {
                                url: `data:image/jpeg;base64,${imageBuffer.toString('base64')}`
                            }
                        }
                    ]
                }
            ],
            max_tokens: 500
        });

        return response.choices[0].message.content;
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð˜Ð˜:', error);
        return 'Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.';
    }
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.onText(/\/start/, async (msg) => {
    console.log('ðŸ“¨ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° /start Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', msg.from.username || msg.from.first_name);
    const chatId = msg.chat.id;
    const user = msg.from;

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ð‘Ð”
    db.run(
        `INSERT OR IGNORE INTO users (telegram_id, username, first_name, last_name) 
     VALUES (?, ?, ?, ?)`,
        [user.id, user.username, user.first_name, user.last_name]
    );

    const welcomeText = `ðŸŽ‰ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² AI Photo Analyzer!

Ð¯ ÑƒÐ¼ÐµÑŽ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð°ÑˆÐ¸ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚Ð° Ð¸ Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ðµ, Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ðµ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ñ‹!

ðŸ“¸ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¼Ð½Ðµ Ñ„Ð¾Ñ‚Ð¾, Ð¸ Ñ Ñ€Ð°ÑÑÐºÐ°Ð¶Ñƒ Ñ‡Ñ‚Ð¾ Ð²Ð¸Ð¶Ñƒ Ð½Ð° Ð½ÐµÐ¼
â° Ð›Ð¸Ð¼Ð¸Ñ‚: 3 Ñ„Ð¾Ñ‚Ð¾ Ð² Ð´ÐµÐ½ÑŒ
âœ¨ ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· ÑƒÐ½Ð¸ÐºÐ°Ð»ÐµÐ½ Ð¸ ÐºÑ€ÐµÐ°Ñ‚Ð¸Ð²ÐµÐ½`;

    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ inline keyboard Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¾Ð¹ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
    const webAppUrl = process.env.WEBAPP_URL || 'https://your-ngrok-url.ngrok.io';
    const keyboard = {
        inline_keyboard: [
            [
                {
                    text: 'ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°',
                    web_app: {
                        url: webAppUrl
                    }
                }
            ]
        ]
    };

    bot.sendMessage(chatId, welcomeText, { reply_markup: keyboard });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
bot.onText(/\/help/, (msg) => {
    const chatId = msg.chat.id;

    const helpText = `ðŸ¤– AI Photo Analyzer - ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ

ðŸ“¸ ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:
1. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°" Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
2. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸
3. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ AI Ð°Ð½Ð°Ð»Ð¸Ð· Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ

âš¡ Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸:
â€¢ ÐÐ½Ð°Ð»Ð¸Ð· Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð˜Ð˜
â€¢ ÐšÑ€Ð°ÑÐ¸Ð²Ñ‹Ðµ Ð¸ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ
â€¢ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð²Ð°ÑˆÐ¸Ñ… Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº
â€¢ Ð›Ð¸Ð¼Ð¸Ñ‚: 3 Ñ„Ð¾Ñ‚Ð¾ Ð² Ð´ÐµÐ½ÑŒ

ðŸ”§ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°:
â€¢ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ /start Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑŽ

âœ¨ ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ!`;

    bot.sendMessage(chatId, helpText);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¹ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐ¸
bot.on('callback_query', (callbackQuery) => {
    const message = callbackQuery.message;
    const chatId = message.chat.id;
    const data = callbackQuery.data;

    if (data === 'launch_webapp') {
        bot.answerCallbackQuery(callbackQuery.id, {
            text: 'ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ...',
            show_alert: false
        });
    }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ñ„Ð¾Ñ‚Ð¾
bot.on('photo', async (msg) => {
    const chatId = msg.chat.id;
    const user = msg.from;

    try {
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¸Ð¼Ð¸Ñ‚
        const canUpload = await checkUploadLimit(user.id);
        if (!canUpload) {
            bot.sendMessage(chatId, 'âŒ Ð’Ñ‹ ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð² 3 Ñ„Ð¾Ñ‚Ð¾ Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð²Ñ‚Ñ€Ð°!');
            return;
        }

        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»
        const photo = msg.photo[msg.photo.length - 1];
        const file = await bot.getFile(photo.file_id);
        const filePath = `https://api.telegram.org/file/bot${process.env.TELEGRAM_BOT_TOKEN}/${file.file_path}`;

        bot.sendMessage(chatId, 'ðŸ” ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽ Ð²Ð°ÑˆÐµ Ñ„Ð¾Ñ‚Ð¾... Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐµÐºÑƒÐ½Ð´.');

        // ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð¾Ñ‚Ð¾
        const analysis = await analyzePhoto(filePath);

        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Ð‘Ð”
        db.run(
            `INSERT INTO photo_uploads (user_id, file_path, ai_analysis) 
       VALUES ((SELECT id FROM users WHERE telegram_id = ?), ?, ?)`,
            [user.id, filePath, analysis]
        );

        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
        bot.sendMessage(chatId, `âœ¨ ÐÐ½Ð°Ð»Ð¸Ð· Ð²Ð°ÑˆÐµÐ³Ð¾ Ñ„Ð¾Ñ‚Ð¾:\n\n${analysis}`);

    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ„Ð¾Ñ‚Ð¾:', error);
        bot.sendMessage(chatId, 'âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ„Ð¾Ñ‚Ð¾. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.');
    }
});

// Health check endpoint
app.get('/api/health', (req, res) => {
    res.json({
        status: 'OK',
        timestamp: new Date().toISOString(),
        uptime: process.uptime()
    });
});

// API endpoints
app.post('/api/upload', upload.single('photo'), async (req, res) => {
    try {
        if (!req.file) {
            return res.status(400).json({ error: 'No file uploaded' });
        }

        const analysis = await analyzePhoto(req.file.path);

        res.json({
            success: true,
            analysis,
            filePath: req.file.path
        });
    } catch (error) {
        console.error('Upload error:', error);
        res.status(500).json({ error: 'Upload failed' });
    }
});

app.get('/api/user/:telegramId/uploads', (req, res) => {
    const { telegramId } = req.params;

    db.all(`
    SELECT pu.*, u.username 
    FROM photo_uploads pu 
    JOIN users u ON pu.user_id = u.id 
    WHERE u.telegram_id = ? 
    ORDER BY pu.uploaded_at DESC
  `, [telegramId], (err, rows) => {
        if (err) {
            res.status(500).json({ error: err.message });
        } else {
            res.json(rows);
        }
    });
});

// Serve React app
app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, '../dist/index.html'));
});

app.listen(PORT, () => {
    console.log(`ðŸš€ Server running on port ${PORT}`);
    console.log(`ðŸ¤– Telegram bot is active`);
});